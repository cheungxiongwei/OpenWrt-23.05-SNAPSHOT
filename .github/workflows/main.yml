name: Build OpenWrt for Cudy TR3000

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions (true/false)'
        required: false
        default: 'false'

env:
  # 1. 源码配置
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  # 指定 Commit Hash 以匹配你当前的固件版本 (OpenWrt 23.05-SNAPSHOT r23001+886-38c150612c)
  # 如果想编译分支最新版，请将此项留空
  REPO_COMMIT: "" 

  # 2. 硬件目标配置 (Cudy TR3000)
  TARGET_BOARD: mediatek
  TARGET_SUBTARGET: filogic
  TARGET_PROFILE: cudy_tr3000

  # 3. 编译选项
  # 设为 true 以编译所有内核模块 (kmod)，确保能提取到你需要的 ipk
  COMPILE_ALL_KMODS: true 
  
  # 时区
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt -yqq update
        sudo -E apt -yqq install build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget
        sudo -E apt -yqq autoremove --purge
        sudo -E apt -yqq autoclean
        sudo -E apt -yqq clean
        sudo -E timedatectl set-timezone "$TZ"
        sudo -E systemctl daemon-reload
      
    - name: Clone Source Code
      run: |
        # 克隆指定分支
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        
        # 如果指定了 REPO_COMMIT，则切换到该提交
        if [ -n "$REPO_COMMIT" ]; then
          echo "Switching to specific commit: $REPO_COMMIT"
          git checkout $REPO_COMMIT
        else
          echo "Using latest commit from branch $REPO_BRANCH"
        fi

    - name: Update & Install Feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Generate Configuration
      working-directory: ./openwrt
      run: |
        rm -f .config
        touch .config

        # 写入目标设备配置
        echo "CONFIG_TARGET_${TARGET_BOARD}=y" >> .config
        echo "CONFIG_TARGET_${TARGET_BOARD}_${TARGET_SUBTARGET}=y" >> .config
        echo "CONFIG_TARGET_${TARGET_BOARD}_${TARGET_SUBTARGET}_DEVICE_${TARGET_PROFILE}=y" >> .config
        
        # 强制编译所有 kmod 内核模块
        if [ "$COMPILE_ALL_KMODS" = "true" ]; then
          echo "CONFIG_ALL_KMODS=y" >> .config
        fi

        # 生成完整配置
        make defconfig

    - name: Download Packages
      working-directory: ./openwrt
      run: |
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile Firmware
      working-directory: ./openwrt
      run: |
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 V=s

    - name: Organize Artifacts
      id: organize
      if: success()
      run: |
        # 清理不必要的包文件以减小体积
        rm -rf openwrt/bin/targets/*/*/packages
        
        mkdir -p ./artifact/firmware
        mkdir -p ./artifact/packages
        
        # 1. 收集固件文件 (sysupgrade.bin)
        cp -rf openwrt/bin/targets/${TARGET_BOARD}/${TARGET_SUBTARGET}/* ./artifact/firmware/
        
        # 2. 收集所有生成的 IPK 文件 (包含 kmod)
        # 将散落在不同目录的 ipk 文件统一复制到输出目录
        find openwrt/bin/ -name "*.ipk" -exec cp {} ./artifact/packages/ \;
        
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success'
      with:
        name: OpenWrt_firmware_${{ env.TARGET_PROFILE }}
        path: ./artifact/firmware/

    - name: Upload Packages (IPKs)
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success'
      with:
        name: OpenWrt_ipks_${{ env.TARGET_PROFILE }}
        path: ./artifact/packages/
