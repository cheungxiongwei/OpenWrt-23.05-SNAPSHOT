name: Build OpenWrt Cudy TR3000 (38c150612c + luci 2891ca4)

on:
  workflow_dispatch:
    inputs:
      custom_config:
        description: '自定义 .config 链接（留空使用内置配置）'
        required: false
      ssh_actions:
        description: '编译完开启 SSH 调试'
        type: boolean
        default: false

env:
  OPENWRT_COMMIT: 38c150612c
  LUCI_COMMIT: 2891ca4
  TARGET: mediatek/filogic
  SUBTARGET: mt7981
  DEVICE: cudy_tr3000-v1
  FILES: "files"
  KEEP_DAYS: 7

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo docker image prune -af || true
        df -h

    - name: Install dependencies
      run: |
        sudo apt update -y
        sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            zlib1g-dev lzop python3 python3-pip rsync unzip wget time

    # 1. 先 clone 并锁定 OpenWrt 主源码
    - name: Clone OpenWrt and lock commit
      run: |
        git clone https://git.openwrt.org/openwrt/openwrt.git openwrt
        cd openwrt
        git checkout ${{ env.OPENWRT_COMMIT }}

    # 2. 删除官方 feeds.conf.default 里默认的 luci 行，防止冲突
    - name: Remove official luci feed
      run: |
        cd openwrt
        sed -i '/\/luci$/d' feeds.conf.default
        # 改为我们自己指定的 commit
        echo "src-git-full luci https://github.com/openwrt/luci.git;${{ env.LUCI_COMMIT }}" >> feeds.conf.default
        cat feeds.conf.default

    # 3. 更新 feeds（此时 luci 已经是我们指定的 commit）
    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 4. 生成配置（强制包含 kmod-mtd-rw）
    - name: Generate .config
      run: |
        cd openwrt
        if [[ -n "${{ inputs.custom_config }}" ]]; then
          wget -q ${{ inputs.custom_config }} -O .config
        else
          cat > .config <<EOF
        CONFIG_TARGET_${{ env.TARGET }}=y
        CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y
        CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}_DEVICE_${{ env.DEVICE }}=y

        CONFIG_PACKAGE_kmod-mtd-rw=y
        CONFIG_PACKAGE_kmod-mtd-rw_insmod=y

        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-ssl-openssl=y
        CONFIG_PACKAGE_luci-app-opkg=y
        CONFIG_PACKAGE_luci-app-turboacc=y
        CONFIG_PACKAGE_wpad-openssl=y
        CONFIG_PACKAGE_kmod-mt7981-firmware=y

        CONFIG_LUCI_SRCDIET=y
        CONFIG_PACKAGE_kmod-tcp-bbr=y
        CONFIG_TURBOACC_ENABLE_SHORTCUT_FE=y
        CONFIG_TURBOACC_ENABLE_FULLCONENAT=y

        CONFIG_VERSIONOPT=y
        CONFIG_VERSION_DIST="OpenWrt"
        CONFIG_VERSION_NUMBER="$(date +%Y%m%d)"
        EOF
        fi
        make defconfig

    - name: Copy custom files
      if: env.FILES != ''
      run: |
        [ -d "${{ github.workspace }}/${{ env.FILES }}" ] && cp -r ${{ github.workspace }}/${{ env.FILES }}/* openwrt/files/

    - name: Cache dl
      uses: actions/cache@v4
      with:
        path: openwrt/dl
        key: dl-${{ env.OPENWRT_COMMIT }}-${{ env.LUCI_COMMIT }}

    - name: Build
      run: |
        cd openwrt
        make -j$(nproc) V=s || make -j1 V=s

    - name: Collect firmware
      run: |
        mkdir -p artifacts/firmware
        cp openwrt/bin/targets/*/*/*.{bin,img,squashfs*} artifacts/firmware/ 2>/dev/null || true
        (cd artifacts/firmware && sha256sum * > sha256sums)

    - name: Collect kmod-mtd-rw ipk
      run: |
        mkdir -p artifacts/ipk
        find openwrt/bin/packages -name "kmod-mtd-rw*" -exec cp {} artifacts/ipk/ \; 2>/dev/null || true
        (cd artifacts/ipk && sha256sum * > sha256sums)

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: Firmware-${{ github.sha }}
        path: artifacts/firmware/*

    - name: Upload kmod-mtd-rw ipk
      uses: actions/upload-artifact@v4
      with:
        name: kmod-mtd-rw-ipk-${{ github.sha }}
        path: artifacts/ipk/*

    - name: Enable SSH debug
      if: inputs.ssh_actions == true
      uses: luchihoratiu/debug-via-ssh@main
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
